@page
@model ERP.Pages.PaperMillProfileView.CreateModel

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Create Paper Mill Profile</h2>
<hr />
<div class="alert alert-danger alert-dismissible" role="alert" id="b-navbar-fg">
    <strong>Oh!</strong> Seems like you did not enter complete data
</div>

@Html.AntiForgeryToken()
<div class="container">
    <div class="panel-group">

        <div class="panel panel-primary">
            <div class="panel-heading">MILL DETAILS</div>
            <div class="panel-body">

                    <div class="col-md-4">
                        <div class="input-group">
                            Mill <select asp-for="CreateViewModel.PaperMillProfile.MillId" class="form-control" asp-items="ViewBag.MillId"></select>

                            <span class="input-group-btn" >
                                <input type="button" value="Load" class="btn btn-default" style="margin-top:20px" id="fetchMillDetails" />
                            </span>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">

                            Mill Name: <input type="text" class="form-control" id="MillName" name="mailName" value="" readonly />

                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            CPM Name: <input type="text" class="form-control" id="CPMPersonName" name="CPMPersonName" value="" readonly />

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            CPM Cell:<input type="text" class="form-control" id="CPMPersonPhone" name="CPMPersonPhone" value="" readonly />

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">

                            Mnaager:<input type="text" class="form-control" id="ManagerPersonName" name="ManagerPersonName" value="" readonly />

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">

                            Manager Cell: <input type="text" class="form-control" id="ManagerPersonPhone" name="ManagerPersonPhone" value="" readonly />

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">

                            Mechanical Name: <input type="text" class="form-control" id="MechanicalName" name="MechanicalName" value="" readonly />

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">

                            Mechanical Cell: <input type="text" class="form-control" id="MechanicalPhone" name="MechanicalPhone" value="" readonly />

                        </div>
                    </div>
                </div>
        </div>

        <div class="panel panel-primary">
            <div class="panel-heading">MILL PROFILE DATA ENTRY SHEER</div>
            <div class="panel-body">

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>


                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfile.RegionId" class="control-label"></label>
                        <select asp-for="CreateViewModel.PaperMillProfile.RegionId" class="form-control" asp-items="ViewBag.RegionId"></select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].FabricId" class="control-label"></label>
                        <select asp-for="CreateViewModel.PaperMillProfileDetails[0].FabricId" class="form-control" asp-items="ViewBag.FabricId"></select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].Width" class="control-label"></label>
                        <input asp-for="CreateViewModel.PaperMillProfileDetails[0].Width" class="form-control" />
                        <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].Width" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].Length" class="control-label"></label>
                        <input asp-for="CreateViewModel.PaperMillProfileDetails[0].Length" class="form-control" />
                        <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].Length" class="text-danger"></span>
                    </div>

                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].GSM" class="control-label"></label>
                        <input asp-for="CreateViewModel.PaperMillProfileDetails[0].GSM" class="form-control" />
                        <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].GSM" class="text-danger"></span>
                    </div>

                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].SM" class="control-label"></label>
                        <input asp-for="CreateViewModel.PaperMillProfileDetails[0].SM" class="form-control" />
                        <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].SM" class="text-danger"></span>
                    </div>

                </div>



                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="CreateViewModel.PaperMillProfileDetails[0].ConsPcsYear" class="control-label"></label>
                        <input asp-for="CreateViewModel.PaperMillProfileDetails[0].ConsPcsYear" class="form-control" />
                        <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].ConsPcsYear" class="text-danger"></span>
                    </div>
                </div>

                    <div class="col-md-4">
                        <div class="input-group">
                            <label asp-for="CreateViewModel.PaperMillProfileDetails[0].NextOrder" class="control-label"></label>
                            <input asp-for="CreateViewModel.PaperMillProfileDetails[0].NextOrder" class="form-control" />
                            <span asp-validation-for="CreateViewModel.PaperMillProfileDetails[0].NextOrder" class="text-danger"></span>

                            <span class="input-group-btn">
                                <input type="button" value="Add" class="btn btn-default" style="margin-top:25px" onclick="_add()" />
                            </span>
                        </div>
                    </div>

                </div>

            <div class="panel-body">
                <table class="table table-striped" id="tblMillProfileDetails">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Fabric</th>
                            <th>Region</th>
                            <th>Width(m)</th>
                            <th>Length(m)</th>
                            <th>Msh./ GSM</th>
                            <th>Rtae/KGM/SM</th>
                            <th>Amount Each Piece</th>
                            <th>Cons.Pcs/ year</th>
                            <th>Cons.Amt/ year</th>
                            <th>Next Order.</th>
                            <th>Next Order Amt.</th>
                        </tr>

                    </thead>
                    <tfoot>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>Total</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn btn-danger" id="deleteOrderLine" onclick="deleteOrderLine()">Delete</button>

            </div>
        </div>

        <div class="panel panel-primary">
            <div class="panel-heading">ACTIONS</div>
            <div class="panel-body">
                <div class="form-group">
                    @foreach (var item in @Model.ActionButtons)
                    {
                        <button type="button" name="submit" value="Link" class="btn col-lg-4 btn-primary" onclick="_prepareJson('@item.ButtonText')"> @item.ButtonText</button>

                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <a asp-page="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        $("#b-navbar-fg").hide();
        getProductRate(); // TODO EDIT
        //poplateFabricDesc();

        $("#fetchMillDetails").click(function () {

            $.ajax({
                type: "GET",
                url: "/PaperMillProfileView/Create?handler=Mills",
                data: "millCode=" + $("#CreateViewModel_PaperMillProfile_MillId option:selected").text(),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {

                    $("#MillName").val(response.name);

                    $("#CPMPersonName").val(response.cpmPerson.name);
                    $("#CPMPersonPhone").val(response.cpmPerson.primaryPhone);


                    $("#ManagerPersonName").val(response.mangerPerson.name);
                    $("#ManagerPersonPhone").val(response.mangerPerson.primaryPhone);

                    $("#MechanicalName").val(response.mechanicalPerson.name);
                    $("#MechanicalPhone").val(response.mechanicalPerson.primaryPhone);

                },
                failure: function (response) {
                    alert(response);
                }
            });

        });

        // on dropdown value change
        $("#CreateViewModel_PaperMillProfileDetails_0__FabricId").change(function () {
            //poplateFabricDesc();
            getProductRate(); // TODO EDIT
        });

        $("#CreateViewModel_PaperMillProfileDetails_0__Width").focusout(function () {

            //var length =
            //$('#CreateViewModel_PaperMillProfileDetails_0__Length').val('')

           // $(this).css("background-color", "#FFDDFF");
        });


    });

    function getProductRate() {
        $.ajax({
            type: "GET",
            url: "/PaperMillProfileView/Create?handler=ProductRate",
            data: "fabricId=" + $("#CreateViewModel_PaperMillProfileDetails_0__FabricId option:selected").val(),
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
                $("#CreateViewModel_PaperMillProfileDetails_0__SM").val(response);
            },

            failure: function (response) {
                alert(response);
            }
        });
    }

    function poplateFabricDesc() {

        $.ajax({
            type: "GET",
            url: "/ConsignmentView/Create?handler=FabricDescription",
            data: "faricId=" + $("#CreateViewModel_PaperMillProfileDetails_0__FabricId option:selected").val(),
            contentType: "application/json",
            dataType: "json",
            success: function (response) {

                $("#CreateViewModel_PaperMillProfileDetails_0__FabricTitle").val(response);
            },
            failure: function (response) {
                alert(response);
            }
        });
    }

    function _allowAdd(a, b, c, d, e) {

        var canAdd = false;
        if ((a != undefined && a != null && a != "")
            && (b != undefined && b != null && b != "")
            && (c != undefined && c != null && c != "")
            && (d != undefined && d != null && d != "" && !isNaN(d))
            && (e != undefined && e != null && e != "")) {
            canAdd = true;
        }
        else {
            canAdd = false;
        }
        return canAdd;
    }

    function _reset() {


        $("#CreateViewModel_PaperMillProfileDetails_0__ Width").val('');
        $('#CreateViewModel_PaperMillProfileDetails_0__Length').val('');
        $("#CreateViewModel_PaperMillProfileDetails_0__GSM").val('');
        //$("#CreateViewModel_PaperMillProfileDetails_0__SM").val(''); // TODO EDIT
        $("#CreateViewModel_PaperMillProfileDetails_0__AmountEachPiece").val('');
        $("#CreateViewModel_PaperMillProfileDetails_0__ConsPcsYear").val('');
        $("#CreateViewModel_PaperMillProfileDetails_0__ConsAmtYear").val('');
        $("#CreateViewModel_PaperMillProfileDetails_0__NextOrder").val('');
        $("#CreateViewModel_PaperMillProfileDetails_0__NextOrderCount").val('');
    }

    function _prepareJson(btnText) {

        if (btnText.toLowerCase() == 'cancel')
            _cancel();
        else {
            var jsonOrder = _millProfileDetails();
            var millId = $("#CreateViewModel_PaperMillProfile_MillId option:selected").val();
            var regionId = $("#CreateViewModel_PaperMillProfile_RegionId option:selected").val();

            var consignmentViewModel = {
                "MillJson": millId,
                "PaperMillProfileJson": jsonOrder,
                "buttonText": btnText,
                "RegionJson": regionId
            };

            $.ajax({
                url: "/PaperMillProfileView/Create?handler=MillProfileDetails",
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                data: JSON.stringify(consignmentViewModel)
            })
                .done(function (result) {
                    window.location.href = '/PaperMillProfileView/Index';
                });
        }

    }

    function _millProfileDetails() {

        var rowLength = $("#tblMillProfileDetails tbody tr").length;
        var rows = $("#tblMillProfileDetails tbody tr");
        var arr = [];
        if (rowLength == 0) {
            //showToastrError("Please Add Soil Details", "Missing Data");
            //return false;
        }
        else {
            for (i = 0; i < rowLength; i++) {
                var fabricId = rows[i].cells[2].innerHTML;
                var regionId = rows[i].cells[4].innerHTML;
                var width = rows[i].cells[5].innerHTML;
                var length = rows[i].cells[6].innerHTML;
                var gsm = rows[i].cells[7].innerHTML;
                var sm = rows[i].cells[8].innerHTML;
                var amountEachPiece = rows[i].cells[9].innerHTML;
                var consPcsYear = rows[i].cells[10].innerHTML;
                var consAmtYear = rows[i].cells[11].innerHTML;
                var nextOrder = rows[i].cells[12].innerHTML;
                var nextOrderCount = rows[i].cells[13].innerHTML;

                arr.push({
                    FabricId: fabricId,
                    RegionId: regionId,
                    Width: width,
                    length: length,
                    GSM: gsm,
                    SM: sm,
                    AmountEachPiece: amountEachPiece,
                    ConsPcsYear: consPcsYear,
                    ConsAmtYear: consAmtYear,
                    NextOrder: nextOrder,
                    NextOrderCount: nextOrderCount
                });
            }

            var jsonOrder = JSON.stringify(arr);
            //$("#ConsignmentOrderJson").val(jsonOrder);
            //var tab = $('#tblMillProfileDetails')
            //row = tab.find('tr').eq(1)[0];

            return jsonOrder;
        }
    }

    function deleteConsignmentOrderLine() {
        $("#tblMillProfileDetails tbody").find('input[name="record"]').each(function () {
            if ($(this).is(":checked")) {
                $(this).parents("tr").remove();
            }
        });
    }

    function _add() {

        var fabricTxt = $("#CreateViewModel_PaperMillProfileDetails_0__FabricId option:selected").text();
        var fabricId = $("#CreateViewModel_PaperMillProfileDetails_0__FabricId option:selected").val();

        var regionTxt = $("#CreateViewModel_PaperMillProfile_RegionId option:selected").text();
        var regionId = $("#CreateViewModel_PaperMillProfile_RegionId option:selected").val();

        var width = $("#CreateViewModel_PaperMillProfileDetails_0__Width").val();
        var length = $("#CreateViewModel_PaperMillProfileDetails_0__Length").val();
        var gsm = $("#CreateViewModel_PaperMillProfileDetails_0__GSM").val();
        var sm = $("#CreateViewModel_PaperMillProfileDetails_0__SM").val();


        // FORUMULA - TODO EDIT
        var amountEachPiece = $("#CreateViewModel_PaperMillProfileDetails_0__AmountEachPiece").val();

        // Handle case for value like 50-55
        if (gsm.includes("-")) {
            amountEachPiece = (parseFloat(width) * parseInt(length) * parseInt(sm));
        }
        else {
            amountEachPiece = (parseFloat(width) * parseInt(length) * (parseInt(gsm) / 1000) * parseInt(sm));
        }

        amountEachPiece = Math.round(amountEachPiece * 100) / 100;

        var consPcsYear = $("#CreateViewModel_PaperMillProfileDetails_0__ConsPcsYear").val();
        //var consAmtYear = $("#CreateViewModel_PaperMillProfileDetails_0__ConsAmtYear").val();

        // TODO EDIT
        consAmtYear = amountEachPiece * parseInt(consPcsYear);

        var nextOrder = $("#CreateViewModel_PaperMillProfileDetails_0__NextOrder").val();
        //TODO EDIT
        //var nextOrderCount = $("#CreateViewModel_PaperMillProfileDetails_0__NextOrderCount").val();

        nextOrderCount = amountEachPiece * parseInt(nextOrder);

        if (_allowAdd(width, length, gsm, consPcsYear, nextOrder))
        {
            $("#b-navbar-fg").hide();

            var markup = "<tr><td><input type='checkbox' name='record'></td><td>" + fabricTxt +
                "</td><td style='display:none'>" + fabricId +
                "</td><td>" + regionTxt +
                "</td><td style='display:none'>" + regionId +
                "</td><td>" + width +
                "</td><td>" + length +
                "</td><td>" + gsm +
                "</td><td>" + sm +
                "</td><td>" + amountEachPiece +
                "</td><td>" + consPcsYear +
                "</td><td>" + consAmtYear +
                "</td><td>" + nextOrder +
                "</td><td>" + nextOrderCount +
                "</td></tr>";


            $("#tblMillProfileDetails tbody").append(markup);

            _reset();
        }
        else {
            $("#b-navbar-fg").show()
        }


        _total();
    }


    function _total() {

        var table = $("#OrderJson");
        var rowLength = $("#tblMillProfileDetails tbody tr").length;
        var rows = $("#tblMillProfileDetails tbody tr");

        var footer = $("#tblMillProfileDetails tfoot tr")

        _resetFooter(footer);


        var arr = [];
        if (rowLength == 0) {
            //showToastrError("Please Add Soil Details", "Missing Data");
            //return false;
        }
        else {
            for (i = 0; i < rowLength; i++) {

                // TODO EDIT
                var totalAmountEachPiece = parseFloat(footer[0].cells[7].innerHTML) + parseFloat(rows[i].cells[9].innerHTML);
                totalAmountEachPiece = totalAmountEachPiece.toLocaleString();
                footer[0].cells[7].innerHTML = totalAmountEachPiece;


                footer[0].cells[8].innerHTML = parseFloat(footer[0].cells[8].innerHTML) + parseFloat(rows[i].cells[10].innerHTML);

                var totalConstAmtYear = parseFloat(footer[0].cells[9].innerHTML) + parseFloat(rows[i].cells[11].innerHTML);
                totalConstAmtYear = totalConstAmtYear.toLocaleString();
                footer[0].cells[9].innerHTML = totalConstAmtYear;
            }
        }
    }

    function _resetFooter(footer) {

        footer[0].cells[7].innerHTML = "0";
        footer[0].cells[8].innerHTML = "0";
        footer[0].cells[9].innerHTML = "0";

    }

    function _cancel() {

         //var url = '@Url.Action("Details", "Branch", new { id = "__id__" })';
        window.location.href = '/ConsignmentView/Index';
    }
</script>